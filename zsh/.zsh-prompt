# --- simple, colored prompt with venv, git, SSH user@host when applicable ---
# Format: "%time [user@host] path git_branch[+*] (venv) ❯"
# - Shows user@host only over SSH.
# - Appends "+" for staged changes and "*" for unstaged or untracked changes.
# - Always shows a green caret; color does not reflect exit status.
# Shared helpers
typeset -g _PROMPT_SCRIPT_DIR="${_PROMPT_SCRIPT_DIR:-${${(%):-%x}:A:h}}"
typeset -g DC_SHARED_DIR="${DC_SHARED_DIR:-${_PROMPT_SCRIPT_DIR}/../shared}"
source "${DC_SHARED_DIR}/prompt.sh"

# Show user@host only over SSH
SSH_PART=''
[[ -n "$SSH_CONNECTION" || -n "$SSH_TTY" ]] && SSH_PART='%n@%m'

# Left prompt: [SSH user@host] path git venv then green caret
autoload -Uz add-zsh-hook

# Recompute PROMPT before each command via precmd hook
build_prompt() {
	local -a segs
	segs+=('%F{244}%*%f')
	[[ -n $SSH_PART ]] && segs+=("$SSH_PART")
	segs+=('%F{blue}%1~%f')

	local git venv
	git="$(prompt_git)"; [[ -n $git ]] && segs+=("%F{cyan}${git}%f")
	venv="$(prompt_venv)"; [[ -n $venv ]] && segs+=("%F{magenta}${venv}%f")

	# Always show green caret regardless of last status
	PROMPT="${(j: :)segs} %F{green}❯%f "
}

add-zsh-hook precmd build_prompt

# Auto-refresh prompt every second (updates clock and catches external git changes)
TRAPALRM() {
  build_prompt
  zle reset-prompt 2>/dev/null
}

# Disable timer during command execution, re-enable when idle at prompt
_zsh_cmd_preexec() { unset TMOUT; }
_zsh_cmd_precmd()  { TMOUT=1; }
add-zsh-hook preexec _zsh_cmd_preexec
add-zsh-hook precmd _zsh_cmd_precmd
TMOUT=1
# --- end ---
