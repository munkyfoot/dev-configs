# --- Welcome banner ---
# Prints a friendly banner once per interactive shell.
# - Chooses ASCII art and color based on time of day
# - Converts custom images to ASCII art if available
# - Shows Node and Python versions when available
# Set `user_name` below to override the greeting name.
# Set `welcome_images_dir` to specify custom image directory.
# To disable, skip sourcing this file or unset `_WELCOME_PRINTED`.

# Get the absolute directory where this script is located
typeset -g _WELCOME_SCRIPT_DIR="${_WELCOME_SCRIPT_DIR:-${${(%):-%x}:A:h}}"

# Source the image-to-ASCII converter
source "${_WELCOME_SCRIPT_DIR}/.zsh-img2ascii"

# Capture terminal width at shell startup (before any resizing)
typeset -g _WELCOME_TERM_WIDTH="${_WELCOME_TERM_WIDTH:-$(tput cols)}"

if [[ $- == *i* ]]; then
  _welcome_banner() {

    # Set username
    local user_name="${USER}" # Uses system username by default, can be changed to any string. e.g. "Your Name"
    
    # Directory containing custom welcome images (morning.*, afternoon.*, evening.*, custom.*)
    # Supported formats: png, jpg, jpeg, gif, bmp, webp
    local welcome_images_dir="${WELCOME_IMAGES_DIR:-${_WELCOME_SCRIPT_DIR}/welcome-images}"

    # Time-of-day greeting
    local h=$(date +%H) part="evening"
    (( h >= 5 && h < 12 )) && part="morning"
    (( h >= 12 && h < 17 )) && part="afternoon"

    # Facts
    # Ordinal suffix helper
    _ordinal_suffix() {
      local d=$((10#$1))
      local suf="th"
      (( d % 100 >= 11 && d % 100 <= 13 )) || case $(( d % 10 )) in
        1) suf="st" ;;
        2) suf="nd" ;;
        3) suf="rd" ;;
      esac
      print -r -- "$suf"
    }

    local day=$((10#$(date +%d)))
    local suffix=$(_ordinal_suffix "$day")
    local today="$(date '+%A, %B') $day$suffix"
    local nodev="N/A"; command -v node >/dev/null && nodev=$(node -v)
    local pyv="N/A"
    if command -v python3 >/dev/null; then
      pyv=$(python3 -V 2>&1 | sed 's/Python /v/')
    fi

    # Preset ASCII art fallback
    _welcome_preset_art() {
      case "$1" in
        morning)
          cat <<'ART'
    ( (
     ) )
  ........
  |      |]
  \      /
   `----'
ART
          ;;
        afternoon)
          cat <<'ART'
      .
   \  |  /
 '-.*;;;*.-'
-==;;;;;;;==-
 .-'*;;;*'-.
   /  |  \
      '
ART
          ;;
        evening)
          cat <<'ART'
    ___
  .'o O'-.
 / O o_.-`\
|o_.-`  o  |
\     o_.-/
 `'--.__.'
ART
          ;;
        *)
          cat <<'ART'
 ><(((ยบ>
ART
          ;;
      esac
    }

    # ASCII art header (time-of-day)
    local art_color
    case "$part" in
      morning)   art_color="cyan" ;;
      afternoon) art_color="yellow" ;;
      evening)   art_color="blue" ;;
      *)         art_color="green" ;;
    esac
    print -P "%F{$art_color}"
    
    # Try to find and convert custom image, fall back to preset ASCII art
    local custom_image=""
    local image_extensions=("png" "jpg" "jpeg" "gif" "bmp" "webp")
    
    for ext in "${image_extensions[@]}"; do
      if
       [[ -f "${welcome_images_dir}/${part}.${ext}" ]]; then
        custom_image="${welcome_images_dir}/${part}.${ext}"
        break
      elif [[ -f "${welcome_images_dir}/custom.${ext}" ]]; then
        custom_image="${welcome_images_dir}/custom.${ext}"
        break
      fi
    done
    
    if [[ -n "$custom_image" ]] && { command -v img2ascii >/dev/null 2>&1 || typeset -f img2ascii >/dev/null 2>&1; }; then
      # Use custom image converted to ASCII art at initial terminal width
      local ascii_art
      ascii_art=$(img2ascii "$custom_image" "$_WELCOME_TERM_WIDTH" 2>/dev/null)
      if [[ -n "$ascii_art" ]]; then
        print -r -- "$ascii_art"
      else
        # Fall back to preset if conversion fails
        _welcome_preset_art "$part"
      fi
    else
      # Use preset ASCII art
      _welcome_preset_art "$part"
    fi
    print -P "%f"

    # Lines
    print -P "%B%F{$art_color}Good ${part}, ${user_name}.%f%b It's ${today}."
    print
    print -P "%F{magenta}Current Environment%f"
    print -P " - %F{green}Node%f ${nodev}"
    print -P " - %F{green}Python%f ${pyv}"

    print
  }

  # Guard so sourcing .zshrc twice doesn't reprint
  if [[ -z "${_WELCOME_PRINTED:-}" ]]; then
    _WELCOME_PRINTED=1
    _welcome_banner
  fi
fi
# --- end ---
